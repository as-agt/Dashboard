<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AS-AGT — Dashboard Marketing</title>
    <link rel="icon" href="https://www.as-agt.fr/wp-content/uploads/2025/04/Logo-AS-AGT-COULEUR.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --agt-green: #69af36;
            --agt-green-light: #7ec44d;
            --agt-green-dark: #508a28;
            --agt-green-soft: rgba(105,175,54,0.08);
            --agt-dark: #1a1e2e;
            --agt-dark-light: #2a2e3e;
            --bg-primary: #faf9f7;
            --bg-secondary: #ffffff;
            --bg-card: #ffffff;
            --bg-hover: #f5f3f0;
            --text-primary: #1a1a1a;
            --text-secondary: #5a5a5a;
            --text-tertiary: #8a8a8a;
            --border-light: rgba(0,0,0,0.06);
            --border-medium: rgba(0,0,0,0.1);
            --success: #2e7d32;
            --success-bg: rgba(46,125,50,0.08);
            --danger: #c62828;
            --danger-bg: rgba(198,40,40,0.08);
            --warning: #ef6c00;
            --warning-bg: rgba(239,108,0,0.08);
            --meta-blue: #1877f2;
            --meta-blue-soft: rgba(24,119,242,0.08);
            --linkedin-blue: #0a66c2;
            --linkedin-blue-soft: rgba(10,102,194,0.08);
            --google-blue: #4285f4;
            --google-soft: rgba(66,133,244,0.08);
            --shadow-xs: 0 1px 2px rgba(0,0,0,0.04);
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.06);
            --shadow-md: 0 4px 16px rgba(0,0,0,0.08);
            --shadow-lg: 0 8px 32px rgba(0,0,0,0.1);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --ease-out: cubic-bezier(0.25,0.46,0.45,0.94);
        }
        *,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
        html{scroll-behavior:smooth;-webkit-font-smoothing:antialiased}
        body{font-family:'Plus Jakarta Sans','Inter',-apple-system,sans-serif;background:var(--bg-primary);color:var(--text-primary);line-height:1.6;overflow-x:hidden}
        .dashboard-layout{display:flex;min-height:100vh}

        /* SIDEBAR */
        .sidebar{width:270px;background:linear-gradient(180deg,#1a1e2e 0%,#252a3a 50%,#1e2232 100%);position:fixed;top:0;left:0;bottom:0;z-index:100;display:flex;flex-direction:column;transition:transform .3s var(--ease-out);box-shadow:4px 0 24px rgba(0,0,0,0.15)}
        .sidebar-header{padding:20px 20px 18px;border-bottom:1px solid rgba(255,255,255,0.07);display:flex;align-items:center;gap:14px}
        .sidebar-logo-img{height:38px;width:auto;opacity:0.95;transition:opacity .2s}
        .sidebar-logo-img:hover{opacity:1}
        .sidebar-badge{font-size:9px;font-weight:700;background:rgba(105,175,54,0.2);color:#8ed45a;padding:2px 8px;border-radius:10px;letter-spacing:.5px;text-transform:uppercase;margin-left:auto}
        .sidebar-nav{flex:1;padding:12px 10px;overflow-y:auto}
        .nav-section{margin-bottom:4px}
        .nav-section-title{font-size:9.5px;font-weight:700;color:rgba(255,255,255,0.28);text-transform:uppercase;letter-spacing:1.8px;padding:14px 14px 6px}
        .nav-item{display:flex;align-items:center;gap:11px;padding:9px 14px;border-radius:var(--radius-sm);color:rgba(255,255,255,0.55);text-decoration:none;font-size:13px;font-weight:500;transition:all .2s var(--ease-out);cursor:pointer;margin-bottom:1px;position:relative}
        .nav-item:hover{background:rgba(255,255,255,0.06);color:rgba(255,255,255,0.9)}
        .nav-item.active{background:rgba(105,175,54,0.2);color:#8ed45a;font-weight:600}
        .nav-item.active::before{content:'';position:absolute;left:0;top:50%;transform:translateY(-50%);width:3px;height:20px;background:#8ed45a;border-radius:0 3px 3px 0}
        .nav-item svg{width:17px;height:17px;flex-shrink:0;opacity:.65}
        .nav-item.active svg{opacity:1}
        .nav-badge{margin-left:auto;background:rgba(105,175,54,0.2);color:#8ed45a;font-size:10px;font-weight:700;padding:1px 7px;border-radius:10px;min-width:20px;text-align:center}
        .sidebar-footer{padding:14px;border-top:1px solid rgba(255,255,255,0.07)}
        .sidebar-user{display:flex;align-items:center;gap:10px;padding:8px;border-radius:var(--radius-sm);cursor:pointer;transition:background .2s}
        .sidebar-user:hover{background:rgba(255,255,255,0.06)}
        .user-avatar{width:34px;height:34px;background:linear-gradient(135deg,var(--agt-green),var(--agt-dark));border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:#fff}
        .user-info{flex:1}
        .user-info .name{font-size:12.5px;font-weight:600;color:rgba(255,255,255,0.9)}
        .user-info .role{font-size:10.5px;color:rgba(255,255,255,0.35)}

        /* MAIN */
        .main-content{flex:1;margin-left:270px;min-height:100vh}
        .topbar{position:sticky;top:0;z-index:50;background:rgba(250,249,247,0.88);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border-bottom:1px solid var(--border-light);padding:0 32px;height:60px;display:flex;align-items:center;justify-content:space-between}
        .topbar-left{display:flex;align-items:center;gap:16px}
        .mobile-menu-btn{display:none;background:none;border:none;cursor:pointer;padding:8px;border-radius:var(--radius-sm);color:var(--text-secondary)}
        .breadcrumb{display:flex;align-items:center;gap:6px;font-size:13px;color:var(--text-tertiary)}
        .breadcrumb .sep{font-size:11px;opacity:.5}
        .breadcrumb .current{color:var(--text-primary);font-weight:600}
        .topbar-right{display:flex;align-items:center;gap:8px}
        .topbar-btn{width:36px;height:36px;border-radius:var(--radius-sm);border:1px solid var(--border-light);background:var(--bg-secondary);display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--text-secondary);transition:all .2s;position:relative}
        .topbar-btn:hover{border-color:var(--border-medium);color:var(--text-primary);box-shadow:var(--shadow-xs)}
        .topbar-btn svg{width:16px;height:16px}
        .notif-dot{position:absolute;top:7px;right:7px;width:6px;height:6px;background:var(--danger);border-radius:50%;border:1.5px solid var(--bg-secondary)}
        .date-selector{display:flex;align-items:center;gap:7px;padding:6px 14px;border-radius:var(--radius-sm);border:1px solid var(--border-light);background:var(--bg-secondary);font-size:12.5px;font-weight:500;color:var(--text-secondary);cursor:pointer;font-family:inherit;transition:all .2s}
        .date-selector:hover{border-color:var(--agt-green);color:var(--text-primary)}
        .date-selector svg{width:14px;height:14px}
        .live-indicator{display:inline-flex;align-items:center;gap:5px;padding:3px 10px;background:var(--success-bg);border-radius:20px;font-size:10px;font-weight:700;color:var(--success);text-transform:uppercase;letter-spacing:.5px}
        .live-dot{width:5px;height:5px;background:var(--success);border-radius:50%;animation:blink 1.5s infinite}
        @keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}

        /* PAGE */
        .page-content{padding:24px 32px 48px;max-width:1480px}
        .page-view{display:none;animation:fadeIn .35s var(--ease-out)}
        .page-view.active{display:block}
        @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
        .page-header{margin-bottom:24px}
        .page-header h2{font-size:24px;font-weight:800;letter-spacing:-.5px;margin-bottom:2px}
        .page-header p{font-size:13px;color:var(--text-tertiary)}
        .header-row{display:flex;align-items:flex-end;justify-content:space-between;gap:16px;flex-wrap:wrap}
        .header-actions{display:flex;gap:8px}
        .btn{display:inline-flex;align-items:center;gap:6px;padding:8px 16px;border-radius:var(--radius-sm);font-size:12.5px;font-weight:600;font-family:inherit;cursor:pointer;transition:all .2s var(--ease-out);border:none;text-decoration:none}
        .btn svg{width:15px;height:15px}
        .btn-primary{background:var(--agt-green);color:#fff;box-shadow:0 2px 8px rgba(105,175,54,.25)}
        .btn-primary:hover{background:var(--agt-green-dark);transform:translateY(-1px)}
        .btn-outline{background:var(--bg-secondary);color:var(--text-secondary);border:1px solid var(--border-light)}
        .btn-outline:hover{border-color:var(--border-medium);color:var(--text-primary)}

        /* TABS */
        .platform-tabs{display:flex;gap:4px;margin-bottom:20px;background:var(--bg-secondary);border:1px solid var(--border-light);border-radius:var(--radius-md);padding:3px;width:fit-content}
        .platform-tab{display:flex;align-items:center;gap:7px;padding:8px 18px;border-radius:7px;font-size:12.5px;font-weight:600;color:var(--text-tertiary);background:0;border:0;cursor:pointer;transition:all .2s var(--ease-out);font-family:inherit}
        .platform-tab:hover{color:var(--text-secondary);background:var(--bg-hover)}
        .platform-tab.active{color:var(--text-primary);background:var(--bg-secondary);box-shadow:var(--shadow-sm)}
        .tab-dot{width:7px;height:7px;border-radius:50%}
        .tab-dot.meta{background:var(--meta-blue)}.tab-dot.linkedin{background:var(--linkedin-blue)}.tab-dot.all{background:var(--agt-green)}

        /* STATUS BANNER */
        .data-status{padding:12px 18px;border-radius:var(--radius-md);margin-bottom:20px;display:flex;align-items:center;gap:10px;font-size:12.5px;font-weight:500}
        .data-status.success{background:var(--success-bg);color:var(--success);border:1px solid rgba(46,125,50,.12)}
        .data-status.error{background:var(--danger-bg);color:var(--danger);border:1px solid rgba(198,40,40,.12)}
        .data-status svg{width:16px;height:16px;flex-shrink:0}

        /* KPI */
        .kpi-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:20px}
        .kpi-card{background:var(--bg-card);border:1px solid var(--border-light);border-radius:var(--radius-lg);padding:18px 20px;transition:all .25s var(--ease-out);position:relative;overflow:hidden}
        .kpi-card::after{content:'';position:absolute;top:0;left:0;right:0;height:2.5px;background:var(--agt-green);opacity:0;transition:opacity .25s}
        .kpi-card:hover{box-shadow:var(--shadow-md);transform:translateY(-2px)}
        .kpi-card:hover::after{opacity:1}
        .kpi-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
        .kpi-label{font-size:11px;font-weight:600;color:var(--text-tertiary);text-transform:uppercase;letter-spacing:.4px}
        .kpi-icon{width:34px;height:34px;border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center}
        .kpi-icon svg{width:16px;height:16px}
        .kpi-icon.green{background:var(--agt-green-soft);color:var(--agt-green)}
        .kpi-icon.blue{background:var(--meta-blue-soft);color:var(--meta-blue)}
        .kpi-icon.meta-i{background:var(--meta-blue-soft);color:var(--meta-blue)}
        .kpi-icon.linkedin-i{background:var(--linkedin-blue-soft);color:var(--linkedin-blue)}
        .kpi-value{font-size:26px;font-weight:800;color:var(--text-primary);line-height:1;margin-bottom:6px;letter-spacing:-.8px}
        .kpi-footer{display:flex;align-items:center;gap:6px}
        .kpi-sub{font-size:11px;color:var(--text-tertiary)}

        /* CHARTS */
        .grid-2-1{display:grid;grid-template-columns:2fr 1fr;gap:14px;margin-bottom:20px}
        .grid-1-1{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:20px}
        .card{background:var(--bg-card);border:1px solid var(--border-light);border-radius:var(--radius-lg);padding:22px;transition:box-shadow .3s}
        .card:hover{box-shadow:var(--shadow-sm)}
        .card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
        .card-title{font-size:14px;font-weight:700}
        .card-subtitle{font-size:11.5px;color:var(--text-tertiary);margin-top:1px}
        .chart-legend{display:flex;gap:14px}
        .legend-item{display:flex;align-items:center;gap:5px;font-size:11px;color:var(--text-secondary);font-weight:500}
        .legend-dot{width:7px;height:7px;border-radius:50%}
        .chart-container{position:relative;height:270px}
        .chart-container.sm{height:220px}

        /* TABLE */
        .table-card{background:var(--bg-card);border:1px solid var(--border-light);border-radius:var(--radius-lg);overflow:hidden;margin-bottom:20px}
        .table-top{display:flex;align-items:center;justify-content:space-between;padding:18px 22px;border-bottom:1px solid var(--border-light)}
        .table-top h3{font-size:14px;font-weight:700}
        .table-filters{display:flex;gap:6px}
        .filter-chip{padding:4px 12px;border-radius:20px;font-size:11.5px;font-weight:600;border:1px solid var(--border-light);background:0;color:var(--text-tertiary);cursor:pointer;transition:all .2s;font-family:inherit}
        .filter-chip:hover,.filter-chip.active{background:var(--agt-green-soft);border-color:var(--agt-green);color:var(--agt-green)}
        table{width:100%;border-collapse:collapse}
        thead th{font-size:10px;font-weight:700;color:var(--text-tertiary);text-transform:uppercase;letter-spacing:.5px;padding:10px 14px;text-align:left;background:var(--bg-hover);border-bottom:1px solid var(--border-light)}
        tbody td{padding:12px 14px;font-size:12.5px;border-bottom:1px solid var(--border-light);color:var(--text-secondary)}
        tbody tr{transition:background .15s}
        tbody tr:hover{background:var(--bg-hover)}
        tbody tr:last-child td{border-bottom:none}
        .camp-name{display:flex;align-items:center;gap:9px}
        .camp-icon{width:26px;height:26px;border-radius:6px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
        .camp-icon.meta-bg{background:var(--meta-blue-soft);color:var(--meta-blue)}
        .camp-icon.linkedin-bg{background:var(--linkedin-blue-soft);color:var(--linkedin-blue)}
        .camp-icon svg{width:13px;height:13px}
        .camp-info .n{font-weight:600;color:var(--text-primary);font-size:12.5px}
        .camp-info .t{font-size:10px;color:var(--text-tertiary)}
        .td-b{font-weight:600;color:var(--text-primary)}
        .perf-bar{width:72px;height:5px;background:var(--bg-hover);border-radius:3px;overflow:hidden}
        .perf-fill{height:100%;border-radius:3px;transition:width 1s var(--ease-out)}
        .perf-fill.g{background:var(--success)}.perf-fill.m{background:var(--warning)}.perf-fill.l{background:var(--danger)}

        /* CONNECTION CARDS */
        .conn-card{padding:22px}
        .conn-item{display:flex;align-items:center;justify-content:space-between;padding:14px;border:1px solid var(--border-light);border-radius:var(--radius-md);margin-bottom:10px;transition:all .2s}
        .conn-item:last-child{margin-bottom:0}
        .conn-item:hover{border-color:var(--border-medium);box-shadow:var(--shadow-xs)}
        .conn-left{display:flex;align-items:center;gap:12px}
        .conn-logo{width:38px;height:38px;border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center}
        .conn-logo.meta{background:var(--meta-blue-soft);color:var(--meta-blue)}
        .conn-logo.linkedin{background:var(--linkedin-blue-soft);color:var(--linkedin-blue)}
        .conn-det h4{font-size:13px;font-weight:600;margin-bottom:1px}
        .conn-det p{font-size:11px;color:var(--text-tertiary)}
        .conn-status{display:flex;align-items:center;gap:5px;font-size:11px;font-weight:600}
        .conn-status.ok{color:var(--success)}.conn-status.warn{color:var(--warning)}
        .pulse{width:7px;height:7px;border-radius:50%;background:currentColor;position:relative}
        .pulse::after{content:'';position:absolute;inset:-3px;border-radius:50%;border:2px solid currentColor;opacity:0;animation:pls 2s infinite}
        @keyframes pls{0%{opacity:.6;transform:scale(.8)}100%{opacity:0;transform:scale(1.6)}}

        /* PLATFORM SUMMARY */
        .plat-block{border:1px solid var(--border-light);border-radius:var(--radius-md);padding:16px;margin-bottom:10px}
        .plat-block:last-child{margin-bottom:0}
        .plat-block-header{display:flex;align-items:center;gap:8px;margin-bottom:12px}
        .plat-block-header .dot{width:9px;height:9px;border-radius:50%}
        .plat-block-header strong{font-size:13px}
        .plat-block-header .count{margin-left:auto;font-size:11px;color:var(--text-tertiary)}
        .plat-metrics{display:grid;grid-template-columns:1fr 1fr;gap:8px}
        .plat-metric{padding:10px;border-radius:8px}
        .plat-metric .lbl{font-size:9.5px;color:var(--text-tertiary);text-transform:uppercase;font-weight:700;letter-spacing:.3px}
        .plat-metric .val{font-size:17px;font-weight:800;margin-top:2px}

        /* OVERLAY / MOBILE */
        .sidebar-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:99}
        .sidebar-overlay.show{display:block}
        .loading-overlay{position:fixed;inset:0;background:var(--bg-primary);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999;transition:opacity .4s,visibility .4s}
        .loading-overlay.hidden{opacity:0;visibility:hidden;pointer-events:none}
        .spinner{width:44px;height:44px;border:3.5px solid var(--border-light);border-top-color:var(--agt-green);border-radius:50%;animation:spin .7s linear infinite;margin-bottom:14px}
        @keyframes spin{to{transform:rotate(360deg)}}
        .loading-text{font-size:13px;color:var(--text-tertiary);font-weight:500}

        ::-webkit-scrollbar{width:5px}
        ::-webkit-scrollbar-track{background:0}
        ::-webkit-scrollbar-thumb{background:var(--border-medium);border-radius:3px}

        /* EMPTY STATE */
        .empty-state{text-align:center;padding:60px 24px;color:var(--text-tertiary)}
        .empty-state svg{width:48px;height:48px;margin-bottom:12px;opacity:.3}
        .empty-state h3{font-size:16px;color:var(--text-secondary);margin-bottom:4px}
        .empty-state p{font-size:13px}

        /* DATE PICKER */
        .date-selector-wrap{position:relative}
        .date-picker-dropdown{position:absolute;top:calc(100% + 8px);right:0;width:340px;background:var(--bg-secondary);border:1px solid var(--border-light);border-radius:var(--radius-lg);box-shadow:var(--shadow-lg);z-index:200;padding:16px;opacity:0;visibility:hidden;transform:translateY(-6px);transition:all .25s var(--ease-out)}
        .date-picker-dropdown.open{opacity:1;visibility:visible;transform:translateY(0)}
        .dp-title{font-size:12px;font-weight:700;color:var(--text-primary);text-transform:uppercase;letter-spacing:.4px;margin-bottom:12px}
        .dp-presets{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:16px}
        .dp-preset{padding:5px 12px;border-radius:20px;font-size:11px;font-weight:600;border:1px solid var(--border-light);background:0;color:var(--text-tertiary);cursor:pointer;transition:all .2s;font-family:inherit}
        .dp-preset:hover{border-color:var(--agt-green);color:var(--agt-green);background:var(--agt-green-soft)}
        .dp-preset.active{background:var(--agt-green);border-color:var(--agt-green);color:#fff}
        .dp-divider{height:1px;background:var(--border-light);margin-bottom:14px}
        .dp-label{font-size:10px;font-weight:700;color:var(--text-tertiary);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px}
        .dp-inputs{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px}
        .dp-input{width:100%;padding:8px 10px;border:1px solid var(--border-light);border-radius:var(--radius-sm);font-size:12px;font-family:inherit;color:var(--text-primary);background:var(--bg-primary);transition:border-color .2s;outline:none}
        .dp-input:focus{border-color:var(--agt-green)}
        .dp-actions{display:flex;gap:8px;justify-content:flex-end}
        .dp-btn{padding:7px 16px;border-radius:var(--radius-sm);font-size:12px;font-weight:600;font-family:inherit;cursor:pointer;transition:all .2s;border:none}
        .dp-btn.apply{background:var(--agt-green);color:#fff}
        .dp-btn.apply:hover{background:var(--agt-green-dark)}
        .dp-btn.reset{background:var(--bg-hover);color:var(--text-secondary);border:1px solid var(--border-light)}
        .dp-btn.reset:hover{background:var(--bg-primary)}
        .dp-overlay{position:fixed;inset:0;z-index:199;display:none}
        .dp-overlay.open{display:block}

        @media(max-width:1200px){.kpi-grid{grid-template-columns:repeat(2,1fr)}.grid-2-1,.grid-1-1{grid-template-columns:1fr}}
        @media(max-width:768px){.sidebar{transform:translateX(-100%)}.sidebar.open{transform:translateX(0)}.main-content{margin-left:0}.mobile-menu-btn{display:flex}.page-content{padding:16px}.kpi-grid{grid-template-columns:repeat(2,1fr)}.topbar{padding:0 12px}.topbar-right{gap:4px}.date-selector{padding:5px 8px;font-size:11px}.date-picker-dropdown{right:0;width:300px}.page-header h2{font-size:20px}.page-header p{font-size:12px}.kpi-value{font-size:22px}.chart-container{height:220px}.chart-container.sm{height:180px}.platform-tabs{width:100%;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none}.platform-tabs::-webkit-scrollbar{display:none}.platform-tab{white-space:nowrap;padding:7px 12px;font-size:11.5px}.table-top{flex-direction:column;align-items:flex-start;gap:10px}.table-filters{flex-wrap:wrap}.conn-item{flex-direction:column;align-items:flex-start;gap:10px}.card{padding:16px}.card-header{flex-direction:column;align-items:flex-start;gap:8px}.header-row{flex-direction:column;align-items:flex-start}.btn{padding:7px 12px;font-size:11.5px}.plat-metrics{grid-template-columns:1fr 1fr}.dp-presets{gap:4px}.dp-preset{padding:4px 10px;font-size:10px}.chart-legend{gap:8px;flex-wrap:wrap}.legend-item{font-size:10px}}
        @media(max-width:480px){.kpi-grid{grid-template-columns:1fr}.date-picker-dropdown{position:fixed;top:auto;bottom:0;left:0;right:0;width:100%;border-radius:var(--radius-lg) var(--radius-lg) 0 0;max-height:80vh;overflow-y:auto}.dp-overlay.open{background:rgba(0,0,0,.4)}.kpi-card{padding:14px 16px}.kpi-value{font-size:20px}.kpi-icon{width:28px;height:28px}.kpi-icon svg{width:13px;height:13px}.chart-container{height:200px}.chart-container.sm{height:160px}.plat-metrics{grid-template-columns:1fr}.topbar{height:50px}.sidebar-header{padding:16px}.page-content{padding:12px}.conn-logo{width:32px;height:32px}.conn-det h4{font-size:12px}}
    </style>
</head>
<body>
<div class="loading-overlay" id="loader"><div class="spinner"></div><div class="loading-text">Chargement des donn&eacute;es AS-AGT...</div></div>

<div class="dashboard-layout">
<!-- SIDEBAR -->
<aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <img src="https://www.as-agt.fr/wp-content/uploads/2025/04/LOGO-AS-AGT-BLANC.png" alt="AS-AGT" class="sidebar-logo-img">
        <span class="sidebar-badge">Marketing</span>
    </div>
    <nav class="sidebar-nav">
        <div class="nav-section">
            <div class="nav-section-title">Tableau de bord</div>
            <a class="nav-item active" data-page="overview">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
                Vue d'ensemble
            </a>
            <a class="nav-item" data-page="performances">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="20" x2="12" y2="10"/><line x1="18" y1="20" x2="18" y2="4"/><line x1="6" y1="20" x2="6" y2="16"/></svg>
                Performances
                <span class="nav-badge" id="perfBadge">-</span>
            </a>
        </div>
        <div class="nav-section">
            <div class="nav-section-title">Campagnes</div>
            <a class="nav-item" data-page="meta">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M2 12h20"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
                Meta Ads
            </a>
            <a class="nav-item" data-page="linkedin">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"/><rect x="2" y="9" width="4" height="12"/><circle cx="4" cy="4" r="2"/></svg>
                LinkedIn Ads
            </a>
        </div>
        <div class="nav-section">
            <div class="nav-section-title">Rapports</div>
            <a class="nav-item" data-page="reports">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
                Rapports
            </a>
        </div>
        <div class="nav-section">
            <div class="nav-section-title">Configuration</div>
            <a class="nav-item" data-page="connections">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
                Connexions API
            </a>
            <a class="nav-item" data-page="settings">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
                Param&egrave;tres
            </a>
        </div>
    </nav>
</aside>
<div class="sidebar-overlay" id="sidebarOverlay"></div>

<!-- MAIN -->
<main class="main-content">
    <header class="topbar">
        <div class="topbar-left">
            <button class="mobile-menu-btn" onclick="toggleSidebar()"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button>
            <div class="breadcrumb">
                <span>Dashboard</span><span class="sep">/</span><span class="current" id="breadcrumbPage">Vue d'ensemble</span>
            </div>
        </div>
        <div class="topbar-right">
            <div class="live-indicator"><span class="live-dot"></span>Live</div>
            <div class="date-selector-wrap">
                <button class="date-selector" id="dateToggle">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                    <span id="dateRange">Chargement...</span>
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:12px;height:12px;opacity:.5"><polyline points="6 9 12 15 18 9"/></svg>
                </button>
                <div class="dp-overlay" id="dpOverlay"></div>
                <div class="date-picker-dropdown" id="datePicker">
                    <div class="dp-title">P&eacute;riode d'analyse</div>
                    <div class="dp-presets">
                        <button class="dp-preset" data-range="7d">7 jours</button>
                        <button class="dp-preset" data-range="30d">30 jours</button>
                        <button class="dp-preset" data-range="3m">3 mois</button>
                        <button class="dp-preset" data-range="6m">6 mois</button>
                        <button class="dp-preset" data-range="12m">12 mois</button>
                        <button class="dp-preset active" data-range="all">Tout</button>
                    </div>
                    <div class="dp-divider"></div>
                    <div class="dp-label">Ou choisir une p&eacute;riode personnalis&eacute;e</div>
                    <div class="dp-inputs">
                        <div><div class="dp-label" style="margin-top:6px">D&eacute;but</div><input type="date" class="dp-input" id="dpStart"></div>
                        <div><div class="dp-label" style="margin-top:6px">Fin</div><input type="date" class="dp-input" id="dpEnd"></div>
                    </div>
                    <div class="dp-actions">
                        <button class="dp-btn reset" id="dpReset">R&eacute;initialiser</button>
                        <button class="dp-btn apply" id="dpApply">Appliquer</button>
                    </div>
                </div>
            </div>
            <button class="topbar-btn" onclick="location.reload()" title="Actualiser"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg></button>
            <button class="topbar-btn" title="Notifications"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg><span class="notif-dot"></span></button>
        </div>
    </header>

    <div class="page-content">
        <!-- DATA STATUS -->
        <div id="dataStatus"></div>

        <!-- PAGE: VUE D'ENSEMBLE -->
        <div class="page-view active" id="page-overview">
            <div class="page-header"><div class="header-row"><div><h2>Vue d'ensemble</h2><p>AS-AGT &bull; Donn&eacute;es en temps r&eacute;el depuis Supermetrics</p></div><div class="header-actions"><button class="btn btn-outline" onclick="location.reload()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>Actualiser</button></div></div></div>
            <div class="platform-tabs"><button class="platform-tab active" onclick="switchPlatform('all',this)"><span class="tab-dot all"></span>Toutes</button><button class="platform-tab" onclick="switchPlatform('meta',this)"><span class="tab-dot meta"></span>Meta Ads</button><button class="platform-tab" onclick="switchPlatform('linkedin',this)"><span class="tab-dot linkedin"></span>LinkedIn Ads</button></div>
            <div class="kpi-grid" id="kpiGrid"></div>
            <div class="grid-1-1"><div class="card"><div class="card-header"><div><div class="card-title">&Eacute;volution des d&eacute;penses</div><div class="card-subtitle">D&eacute;penses mensuelles Meta vs LinkedIn</div></div><div class="chart-legend"><div class="legend-item"><span class="legend-dot" style="background:var(--meta-blue)"></span>Meta</div><div class="legend-item"><span class="legend-dot" style="background:var(--linkedin-blue)"></span>LinkedIn</div></div></div><div class="chart-container"><canvas id="spendChart"></canvas></div></div><div class="card"><div class="card-header"><div><div class="card-title">Leads par mois</div><div class="card-subtitle">Prospects g&eacute;n&eacute;r&eacute;s via Meta &amp; LinkedIn</div></div><div class="chart-legend"><div class="legend-item"><span class="legend-dot" style="background:var(--meta-blue)"></span>Meta</div><div class="legend-item"><span class="legend-dot" style="background:var(--linkedin-blue)"></span>LinkedIn</div></div></div><div class="chart-container"><canvas id="leadsChart"></canvas></div></div></div>
            <div class="grid-1-1"><div class="card"><div class="card-header"><div><div class="card-title">R&eacute;partition du budget</div><div class="card-subtitle">Par audience / ensemble de publicit&eacute;s</div></div></div><div class="chart-container"><canvas id="budgetChart"></canvas></div></div><div class="card"><div class="card-header"><div><div class="card-title">Co&ucirc;t par lead</div><div class="card-subtitle">&Eacute;volution mensuelle du CPL</div></div></div><div class="chart-container"><canvas id="cplChart"></canvas></div></div></div>
            <div class="grid-1-1"><div class="card"><div class="card-header"><div><div class="card-title">CTR par audience</div><div class="card-subtitle">Taux de clics par ensemble de publicit&eacute;s</div></div></div><div class="chart-container"><canvas id="ctrChart"></canvas></div></div><div class="card"><div class="card-header"><div><div class="card-title">Leads par audience</div><div class="card-subtitle">Prospects par ensemble de publicit&eacute;s</div></div></div><div class="chart-container"><canvas id="leadsAudienceChart"></canvas></div></div></div>
        </div>

        <!-- PAGE: PERFORMANCES -->
        <div class="page-view" id="page-performances">
            <div class="page-header"><h2>Performances</h2><p>D&eacute;tail complet par ensemble de publicit&eacute;s</p></div>
            <div class="table-card"><div class="table-top"><h3>Toutes les campagnes</h3><div class="table-filters"><button class="filter-chip active" onclick="filterTable('all',this)">Tous</button><button class="filter-chip" onclick="filterTable('meta',this)">Meta</button><button class="filter-chip" onclick="filterTable('linkedin',this)">LinkedIn</button></div></div><div style="overflow-x:auto"><table><thead><tr><th>Campagne / Audience</th><th>Plateforme</th><th>Impressions</th><th>Clics</th><th>CTR</th><th>Co&ucirc;t</th><th>Leads</th><th>Co&ucirc;t/Lead</th><th>Perf.</th></tr></thead><tbody id="tableBody"><tr><td colspan="9" style="text-align:center;padding:40px;color:var(--text-tertiary)">Chargement...</td></tr></tbody></table></div></div>
        </div>

        <!-- PAGE: META ADS -->
        <div class="page-view" id="page-meta">
            <div class="page-header"><h2>Meta Ads</h2><p>Campagnes AS-AGT &mdash; Facebook & Instagram</p></div>
            <div class="kpi-grid" id="metaKpiGrid"></div>
            <div class="grid-1-1"><div class="card"><div class="card-header"><div><div class="card-title">D&eacute;penses Meta par mois</div></div></div><div class="chart-container"><canvas id="metaSpendChart"></canvas></div></div><div class="card"><div class="card-header"><div><div class="card-title">Leads par mois</div></div></div><div class="chart-container"><canvas id="metaLeadsChart"></canvas></div></div></div>
            <div class="table-card"><div class="table-top"><h3>D&eacute;tail par audience</h3></div><div style="overflow-x:auto"><table><thead><tr><th>Audience</th><th>Impressions</th><th>Clics</th><th>Clics liens</th><th>CTR</th><th>Co&ucirc;t</th><th>Leads</th><th>Co&ucirc;t/Lead</th></tr></thead><tbody id="metaTableBody"></tbody></table></div></div>
        </div>

        <!-- PAGE: LINKEDIN ADS -->
        <div class="page-view" id="page-linkedin">
            <div class="page-header"><h2>LinkedIn Ads</h2><p>Campagnes AS-AGT &mdash; Lead Gen LinkedIn</p></div>
            <div class="kpi-grid" id="linkedinKpiGrid"></div>
            <div class="grid-1-1"><div class="card"><div class="card-header"><div><div class="card-title">D&eacute;penses LinkedIn par mois</div></div></div><div class="chart-container"><canvas id="linkedinSpendChart"></canvas></div></div><div class="card"><div class="card-header"><div><div class="card-title">Leads par mois</div></div></div><div class="chart-container"><canvas id="linkedinLeadsChart"></canvas></div></div></div>
            <div class="table-card"><div class="table-top"><h3>D&eacute;tail LinkedIn Ads</h3></div><div style="overflow-x:auto"><table><thead><tr><th>Campagne</th><th>Impressions</th><th>Clics</th><th>CTR</th><th>Co&ucirc;t</th><th>Leads</th><th>Formulaires</th><th>Co&ucirc;t/Lead</th></tr></thead><tbody id="linkedinTableBody"></tbody></table></div></div>
        </div>

        <!-- PAGE: RAPPORTS -->
        <div class="page-view" id="page-reports">
            <div class="page-header"><h2>Rapports</h2><p>R&eacute;sum&eacute; des performances Meta &amp; LinkedIn Ads</p></div>
            <div class="grid-1-1" id="reportSummary"></div>
            <div class="card" style="margin-bottom:20px"><div class="card-header"><div><div class="card-title">Co&ucirc;t par lead &mdash; &Eacute;volution</div><div class="card-subtitle">Comparaison mensuelle Meta vs LinkedIn</div></div><div class="chart-legend"><div class="legend-item"><span class="legend-dot" style="background:var(--meta-blue)"></span>Meta</div><div class="legend-item"><span class="legend-dot" style="background:var(--linkedin-blue)"></span>LinkedIn</div></div></div><div class="chart-container"><canvas id="reportCplChart"></canvas></div></div>
        </div>

        <!-- PAGE: CONNEXIONS -->
        <div class="page-view" id="page-connections">
            <div class="page-header"><h2>Connexions API</h2><p>Sources de donn&eacute;es actives et configuration</p></div>
            <div class="card conn-card">
                <div class="conn-item"><div class="conn-left"><div class="conn-logo meta"><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.477 2 2 6.477 2 12c0 4.991 3.657 9.128 8.438 9.879V14.89h-2.54V12h2.54V9.797c0-2.506 1.492-3.89 3.777-3.89 1.094 0 2.238.195 2.238.195v2.46h-1.26c-1.243 0-1.63.771-1.63 1.562V12h2.773l-.443 2.89h-2.33v6.989C18.343 21.129 22 16.99 22 12c0-5.523-4.477-10-10-10z"/></svg></div><div class="conn-det"><h4>Meta Ads (Facebook & Instagram)</h4><p id="metaConnInfo">V&eacute;rification...</p></div></div><div class="conn-status warn" id="metaConnSt"><span class="pulse"></span><span id="metaConnLbl">...</span></div></div>
                <div class="conn-item"><div class="conn-left"><div class="conn-logo linkedin"><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433a2.062 2.062 0 0 1-2.063-2.065 2.064 2.064 0 1 1 2.063 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg></div><div class="conn-det"><h4>LinkedIn Ads (Lead Gen)</h4><p id="linkedinConnInfo">V&eacute;rification...</p></div></div><div class="conn-status warn" id="linkedinConnSt"><span class="pulse"></span><span id="linkedinConnLbl">...</span></div></div>
            </div>
            <div class="card" style="margin-top:14px;padding:20px">
                <div class="card-title" style="margin-bottom:12px">Informations techniques</div>
                <div style="font-size:12px;color:var(--text-secondary);line-height:1.8">
                    <strong>Source :</strong> Google Sheets via Supermetrics<br>
                    <strong>Spreadsheet :</strong> <code style="background:var(--bg-hover);padding:2px 6px;border-radius:4px;font-size:11px">2PACX-1vRiWc8yPpg7phWPVu5gl2kvhvtGyldz8reMO5MX6PbGz7iAtirz35vlJtez3JQgtO4Km0LMO6OOmn_9</code><br>
                    <strong>Meta Ads GID :</strong> 1597510134<br>
                    <strong>LinkedIn Ads GID :</strong> 339874225<br>
                    <strong>Refresh :</strong> Automatique via Supermetrics (quotidien)
                </div>
            </div>
        </div>

        <!-- PAGE: PARAMETRES -->
        <div class="page-view" id="page-settings">
            <div class="page-header"><h2>Param&egrave;tres</h2><p>Configuration du dashboard AS-AGT</p></div>
            <div class="card" style="padding:24px">
                <div style="display:flex;align-items:center;gap:14px;margin-bottom:24px">
                    <img src="https://www.as-agt.fr/wp-content/uploads/2025/04/Logo-AS-AGT-COULEUR.png" style="width:56px;height:56px;border-radius:50%;border:2px solid var(--border-light);object-fit:contain;background:#fff">
                    <div><div style="font-size:16px;font-weight:700">AS-AGT</div><div style="font-size:12px;color:var(--text-tertiary)">Agencement &bull; Menuiserie &bull; Ma&icirc;trise d'&oelig;uvre</div></div>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px">
                    <div style="padding:16px;border:1px solid var(--border-light);border-radius:var(--radius-md)"><div style="font-size:11px;color:var(--text-tertiary);text-transform:uppercase;font-weight:600;margin-bottom:4px">Client</div><div style="font-size:14px;font-weight:600">AS-AGT</div></div>
                    <div style="padding:16px;border:1px solid var(--border-light);border-radius:var(--radius-md)"><div style="font-size:11px;color:var(--text-tertiary);text-transform:uppercase;font-weight:600;margin-bottom:4px">Zone</div><di style="font-size:14px;font-weight:600">Chemill&eacute;-en-Anjou (49)</div></div>
                    <div style="padding:16px;border:1px solid var(--border-light);border-radius:var(--radius-md)"><div style="font-size:11px;color:var(--text-tertiary);text-transform:uppercase;font-weight:600;margin-bottom:4px">Site web</div><div style="font-size:14px;font-weight:600"><a href="https://www.as-agt.fr/" target="_blank" style="color:var(--agt-green);text-decoration:none">www.as-agt.fr</a></div></div>
                    <div style="padding:16px;border:1px solid var(--border-light);border-radius:var(--radius-md)"><div style="font-size:11px;color:var(--text-tertiary);text-transform:uppercase;font-weight:600;margin-bottom:4px">Dashboard</div><div style="font-size:14px;font-weight:600">v1.0 &mdash; Live</div></div>
                </div>
            </div>
        </div>
    </div>
</main>
</div>

<script>
/* ══════════════════════════════════════════════════════════════
   AS-AGT — DASHBOARD ENGINE v2 (Meta Ads + LinkedIn Ads)
   ══════════════════════════════════════════════════════════════ */
const META_URL='https://docs.google.com/spreadsheets/d/e/2PACX-1vRiWc8yPpg7phWPVu5gl2kvhvtGyldz8reMO5MX6PbGz7iAtirz35vlJtez3JQgtO4Km0LMO6OOmn_9/pub?output=csv&single=true&gid=1597510134';
const LINKEDIN_URL='https://docs.google.com/spreadsheets/d/e/2PACX-1vRiWc8yPpg7phWPVu5gl2kvhvtGyldz8reMO5MX6PbGz7iAtirz35vlJtez3JQgtO4Km0LMO6OOmn_9/pub?output=csv&single=true&gid=339874225';

Chart.defaults.font.family="'Plus Jakarta Sans','Inter',sans-serif";
Chart.defaults.color='#8a8a8a';

let allMD=[],allLI=[],MD=[],LI=[],charts={},curPlatform='all',curTableFilter='all';
let dateStart=null,dateEnd=null,dataMinDate=null,dataMaxDate=null;

// CSV parsing
function parseCSV(t){const ls=t.split('\n');if(ls.length<2)return[];const h=csvLine(ls[0]),d=[];for(let i=1;i<ls.length;i++){const l=ls[i].trim();if(!l)continue;const v=csvLine(l),r={};h.forEach((k,j)=>{r[k.trim().replace(/^"|"$/g,'')]=(v[j]||'').replace(/^"|"$/g,'')});d.push(r)}return d}
function csvLine(l){const r=[];let c='',q=false;for(let i=0;i<l.length;i++){const ch=l[i];if(ch==='"'){if(q&&l[i+1]==='"'){c+='"';i++}else q=!q}else if(ch===','&&!q){r.push(c);c=''}else c+=ch}r.push(c);return r}

function pN(v){if(!v||v==='-')return 0;let s=String(v).replace(/\s/g,'').replace(/[^0-9.,-]/g,'');if(s.includes(',')&&s.includes('.')){s.lastIndexOf(',')>s.lastIndexOf('.')?s=s.replace(/\./g,'').replace(',','.'):s=s.replace(/,/g,'')}else if(s.includes(','))s=s.replace(',','.');const n=parseFloat(s);return isNaN(n)?0:n}
function pP(v){if(!v||v==='-')return 0;return parseFloat(String(v).replace(/[%\s]/g,'').replace(',','.'))||0}

function fC(r,ns){for(const n of ns)if(r[n]!==undefined&&r[n]!=='')return r[n];const ks=Object.keys(r);for(const n of ns){const lo=n.toLowerCase();for(const k of ks)if(k.toLowerCase().includes(lo)||lo.includes(k.toLowerCase()))if(r[k]!==undefined&&r[k]!=='')return r[k]}return''}

function cleanAd(name){if(!name)return'Autre';return name}

function mapMeta(r){return{
    p:'meta',
    camp:fC(r,['Nom de la campagne','Campaign name']),
    ad:cleanAd(fC(r,["Nom de l'ensemble de publicités","Nom de l'ensemble de publicites",'Ad set name'])),
    dt:fC(r,['Date']),
    imp:pN(fC(r,['Impressions'])),
    cl:pN(fC(r,['Clics (tous)','Clicks (all)','Clics'])),
    cost:pN(fC(r,['Coût (EUR)','Cout (EUR)','Cost (EUR)','Cost'])),
    linkCl:pN(fC(r,['Clics sur les liens','Link clicks','Link Clicks'])),
    ctr:pP(fC(r,['CTR (tous)','CTR'])),
    leads:pN(fC(r,['Prospects sur Facebook','Leads','Prospects'])),
    formOpens:0,
    cpl:pN(fC(r,['Coût par prospect sur Facebook','Cost per lead','CPL']))
}}
function mapLI(r){return{
    p:'linkedin',
    camp:fC(r,['Nom de la campagne','Campaign name']),
    ad:fC(r,['Nom de la campagne','Campaign name']),
    dt:fC(r,['Date']),
    imp:pN(fC(r,['Impressions'])),
    cl:pN(fC(r,['Clics','Clicks'])),
    cost:pN(fC(r,['Total dépensé (EUR)','Total spent (EUR)','Cost'])),
    linkCl:0,
    ctr:pP(fC(r,['CTR'])),
    leads:pN(fC(r,['Leads'])),
    formOpens:pN(fC(r,['Ouvertures de formulaire de lead','Lead form opens'])),
    cpl:pN(fC(r,['Coût par lead','Cost per lead','CPL']))
}}

async function fetchCSV(u){const r=await fetch(u);if(!r.ok)throw new Error(r.status);return parseCSV(await r.text())}

// Date normalization
function normDate(dt){
    if(!dt)return null;
    const m1=dt.match(/^(\d{4})-(\d{2})-(\d{2})/);
    if(m1)return m1[0];
    const m2=dt.match(/^(\d{2})\/(\d{2})\/(\d{4})/);
    if(m2)return m2[3]+'-'+m2[2]+'-'+m2[1];
    return null;
}

function filterByDate(data){
    if(!dateStart&&!dateEnd)return data;
    return data.filter(r=>{
        const d=normDate(r.dt);
        if(!d)return false;
        if(dateStart&&d<dateStart)return false;
        if(dateEnd&&d>dateEnd)return false;
        return true;
    });
}

// Helpers
const sum=(d,f)=>d.reduce((a,r)=>a+(r[f]||0),0);
const MN=['Janv.','Fév.','Mars','Avr.','Mai','Juin','Juil.','Août','Sept.','Oct.','Nov.','Déc.'];
const MN_FULL=['janvier','février','mars','avril','mai','juin','juillet','août','septembre','octobre','novembre','décembre'];
function mKey(dt){if(!dt)return null;const m=dt.match(/(\d{4})-(\d{2})/);if(m)return m[1]+'-'+m[2];const m2=dt.match(/(\d{2})\/(\d{2})\/(\d{4})/);return m2?m2[3]+'-'+m2[2]:null}
function mLabel(k){const[y,m]=k.split('-');return MN[parseInt(m)-1]+' '+y.slice(2)}
function grpMonth(d){const g={};d.forEach(r=>{const k=mKey(r.dt);if(k){if(!g[k])g[k]=[];g[k].push(r)}});return g}
function grpAd(d){const g={};d.forEach(r=>{const k=r.ad||r.camp||'Autre';if(!g[k])g[k]=[];g[k].push(r)});return g}
function fE(n){return new Intl.NumberFormat('fr-FR',{style:'currency',currency:'EUR',minimumFractionDigits:0,maximumFractionDigits:0}).format(n)}
function fE2(n){return new Intl.NumberFormat('fr-FR',{style:'currency',currency:'EUR',minimumFractionDigits:2,maximumFractionDigits:2}).format(n)}
function fN(n){return new Intl.NumberFormat('fr-FR').format(Math.round(n))}
function fPct(n){return n.toFixed(2).replace('.',',')+' %'}

function formatDateFR(iso){
    if(!iso)return '';
    const[y,m,d]=iso.split('-');
    return parseInt(d)+' '+MN_FULL[parseInt(m)-1]+' '+y;
}

function getData(p){return p==='meta'?MD:p==='linkedin'?LI:[...MD,...LI]}

const ICO_META='<svg viewBox="0 0 24 24" fill="currentColor" width="13" height="13"><path d="M12 2C6.477 2 2 6.477 2 12c0 4.991 3.657 9.128 8.438 9.879V14.89h-2.54V12h2.54V9.797c0-2.506 1.492-3.89 3.777-3.89 1.094 0 2.238.195 2.238.195v2.46h-1.26c-1.243 0-1.63.771-1.63 1.562V12h2.773l-.443 2.89h-2.33v6.989C18.343 21.129 22 16.99 22 12c0-5.523-4.477-10-10-10z"/></svg>';
const ICO_LI='<svg viewBox="0 0 24 24" fill="currentColor" width="13" height="13"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433a2.062 2.062 0 0 1-2.063-2.065 2.064 2.064 0 1 1 2.063 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg>';

// RENDER ALL
function renderAll(){
    MD=filterByDate(allMD);
    LI=filterByDate(allLI);
    updateDateDisplay();
    renderKPIs(curPlatform);
    renderOverviewCharts();
    renderTable(curTableFilter);
    renderMetaPage();
    renderLinkedinPage();
    renderReports();
    document.getElementById('perfBadge').textContent=Object.keys({...grpAd(MD),...grpAd(LI)}).length;
}

function updateDateDisplay(){
    const ds=[...MD,...LI].map(r=>normDate(r.dt)).filter(Boolean).sort();
    const el=document.getElementById('dateRange');
    if(ds.length){
        el.textContent=formatDateFR(ds[0])+' — '+formatDateFR(ds[ds.length-1]);
    } else {
        el.textContent='Aucune donnée';
    }
}

// INIT
async function init(){
    let mOk=false,liOk=false;
    try{const raw=await fetchCSV(META_URL);allMD=raw.map(mapMeta).filter(r=>r.dt);mOk=allMD.length>0}catch(e){console.error('Meta:',e)}
    try{const raw=await fetchCSV(LINKEDIN_URL);allLI=raw.map(mapLI).filter(r=>r.dt);liOk=allLI.length>0}catch(e){console.error('LinkedIn:',e)}

    const st=document.getElementById('dataStatus');
    if(mOk||liOk){st.innerHTML=''}
    else{st.innerHTML='<div class="data-status error"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>Impossible de charger. V&eacute;rifiez que le Sheet est publi&eacute; sur le Web.</div>'}

    const allDates=[...allMD,...allLI].map(r=>normDate(r.dt)).filter(Boolean).sort();
    if(allDates.length){
        dataMinDate=allDates[0];
        dataMaxDate=allDates[allDates.length-1];
        document.getElementById('dpStart').min=dataMinDate;
        document.getElementById('dpStart').max=dataMaxDate;
        document.getElementById('dpEnd').min=dataMinDate;
        document.getElementById('dpEnd').max=dataMaxDate;
    }

    // Conn status
    setConn('meta',mOk,allMD.length);
    setConn('linkedin',liOk,allLI.length);

    renderAll();
    initDatePicker();
    document.getElementById('loader').classList.add('hidden');
}
function setConn(p,ok,n){
    document.getElementById(p+'ConnInfo').textContent=ok?n+' lignes via Supermetrics':'Aucune donnée';
    document.getElementById(p+'ConnSt').className='conn-status '+(ok?'ok':'warn');
    document.getElementById(p+'ConnLbl').textContent=ok?'Connecté':'Erreur';
}

// DATE PICKER
function initDatePicker(){
    const toggle=document.getElementById('dateToggle');
    const picker=document.getElementById('datePicker');
    const overlay=document.getElementById('dpOverlay');
    const dpStart=document.getElementById('dpStart');
    const dpEnd=document.getElementById('dpEnd');

    function openDP(){picker.classList.add('open');overlay.classList.add('open')}
    function closeDP(){picker.classList.remove('open');overlay.classList.remove('open')}

    toggle.addEventListener('click',()=>{picker.classList.contains('open')?closeDP():openDP()});
    overlay.addEventListener('click',closeDP);

    document.querySelectorAll('.dp-preset').forEach(btn=>{
        btn.addEventListener('click',()=>{
            document.querySelectorAll('.dp-preset').forEach(b=>b.classList.remove('active'));
            btn.classList.add('active');
            const range=btn.dataset.range;
            if(range==='all'){
                dateStart=null;dateEnd=null;
                dpStart.value='';dpEnd.value='';
            } else {
                const end=new Date(dataMaxDate+'T00:00:00');
                const start=new Date(dataMaxDate+'T00:00:00');
                if(range==='7d')start.setDate(start.getDate()-7);
                else if(range==='30d')start.setDate(start.getDate()-30);
                else if(range==='3m')start.setMonth(start.getMonth()-3);
                else if(range==='6m')start.setMonth(start.getMonth()-6);
                else if(range==='12m')start.setFullYear(start.getFullYear()-1);
                dateStart=start.toISOString().slice(0,10);
                dateEnd=dataMaxDate;
                dpStart.value=dateStart;
                dpEnd.value=dateEnd;
            }
            renderAll();
            closeDP();
        });
    });

    document.getElementById('dpApply').addEventListener('click',()=>{
        dateStart=dpStart.value||null;
        dateEnd=dpEnd.value||null;
        document.querySelectorAll('.dp-preset').forEach(b=>b.classList.remove('active'));
        if(!dateStart&&!dateEnd){
            document.querySelector('.dp-preset[data-range="all"]').classList.add('active');
        }
        renderAll();
        closeDP();
    });

    document.getElementById('dpReset').addEventListener('click',()=>{
        dateStart=null;dateEnd=null;
        dpStart.value='';dpEnd.value='';
        document.querySelectorAll('.dp-preset').forEach(b=>b.classList.remove('active'));
        document.querySelector('.dp-preset[data-range="all"]').classList.add('active');
        renderAll();
        closeDP();
    });
}

// NAVIGATION
document.querySelectorAll('.nav-item[data-page]').forEach(item=>{
    item.addEventListener('click',()=>{
        document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
        item.classList.add('active');
        const page=item.dataset.page;
        document.querySelectorAll('.page-view').forEach(v=>v.classList.remove('active'));
        document.getElementById('page-'+page).classList.add('active');
        document.getElementById('breadcrumbPage').textContent=item.textContent.trim();
        document.getElementById('sidebar').classList.remove('open');
        document.getElementById('sidebarOverlay').classList.remove('show');
    });
});

// KPIs
function renderKPIs(p){
    const d=getData(p),sp=sum(d,'cost'),ld=sum(d,'leads'),cl=sum(d,'cl'),im=sum(d,'imp'),lkCl=sum(d,'linkCl');
    const cpl=ld>0?sp/ld:0,ctr=im>0?(cl/im)*100:0;
    const lbl=p==='all'?'Meta + LinkedIn':p==='meta'?'Meta Ads':'LinkedIn Ads';
    document.getElementById('kpiGrid').innerHTML=kpiHTML([
        {label:'Dépenses totales',value:fE(sp),sub:lbl,icon:'green',svg:'<line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>'},
        {label:'Leads générés',value:fN(ld),sub:fN(im)+' impressions',icon:'blue',svg:'<path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/>'},
        {label:'Coût / Lead',value:ld>0?fE2(cpl):'-',sub:fN(cl)+' clics',icon:'green',svg:'<circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>'},
        {label:'CTR moyen',value:fPct(ctr),sub:lbl,icon:'blue',svg:'<polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>'}
    ]);
}
function kpiHTML(items){return items.map(i=>'<div class="kpi-card"><div class="kpi-header"><span class="kpi-label">'+i.label+'</span><div class="kpi-icon '+i.icon+'"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">'+i.svg+'</svg></div></div><div class="kpi-value">'+i.value+'</div><div class="kpi-footer"><span class="kpi-sub">'+i.sub+'</span></div></div>').join('')}

// OVERVIEW CHARTS
function renderOverviewCharts(){
    const mm=grpMonth(MD),lm=grpMonth(LI);
    const ks=[...new Set([...Object.keys(mm),...Object.keys(lm)])].sort();
    // Spend
    makeChart('spendChart','bar',ks.map(mLabel),[{label:'Meta',data:ks.map(k=>sum(mm[k]||[],'cost')),backgroundColor:'rgba(24,119,242,.75)',borderRadius:6,borderSkipped:false},{label:'LinkedIn',data:ks.map(k=>sum(lm[k]||[],'cost')),backgroundColor:'rgba(10,102,194,.55)',borderRadius:6,borderSkipped:false}],{y:{ticks:{callback:v=>fE(v)}}});
    // Leads
    makeChart('leadsChart','line',ks.map(mLabel),[{label:'Meta',data:ks.map(k=>sum(mm[k]||[],'leads')),borderColor:'#1877f2',backgroundColor:'rgba(24,119,242,.1)',borderWidth:2.5,fill:true,tension:.4,pointRadius:3,pointBackgroundColor:'#1877f2'},{label:'LinkedIn',data:ks.map(k=>sum(lm[k]||[],'leads')),borderColor:'#0a66c2',backgroundColor:'rgba(10,102,194,.08)',borderWidth:2.5,fill:true,tension:.4,pointRadius:3,pointBackgroundColor:'#0a66c2'}],{y:{beginAtZero:true}});
    // Budget doughnut
    const allD=[...MD,...LI],ag=grpAd(allD),labs=[],vals=[],cols=['#1877f2','#42a5f5','#0a66c2','#64b5f6','#90caf9','#69af36','#8ed45a','#bbdefb'];
    Object.entries(ag).sort((a,b)=>sum(b[1],'cost')-sum(a[1],'cost')).forEach(([n,r])=>{labs.push(n);vals.push(sum(r,'cost'))});
    makeDoughnut('budgetChart',labs,vals,cols);
    // CPL trend
    const allMo=grpMonth(allD),allKs=Object.keys(allMo).sort();
    const cplData=allKs.map(k=>{const d=allMo[k],c=sum(d,'cost'),l=sum(d,'leads');return l>0?Math.round(c/l*100)/100:null});
    makeChart('cplChart','line',allKs.map(mLabel),[{data:cplData,borderColor:'#ef6c00',backgroundColor:'rgba(239,108,0,.1)',borderWidth:2.5,fill:true,tension:.4,pointRadius:4,pointBackgroundColor:'#ef6c00',spanGaps:true}],{y:{ticks:{callback:v=>v+' €'}}});
    // CTR by audience
    const ctrL=[],ctrV=[];
    Object.entries(ag).forEach(([n,rs])=>{const im=sum(rs,'imp'),cl=sum(rs,'cl');ctrL.push(n);ctrV.push(im>0?Math.round((cl/im)*10000)/100:0)});
    makeChart('ctrChart','bar',ctrL,[{data:ctrV,backgroundColor:'rgba(24,119,242,.65)',borderRadius:6,borderSkipped:false}],{x:{ticks:{callback:v=>v+'%'}}},{indexAxis:'y'});
    // Leads by audience
    const ldL=[],ldV=[];
    Object.entries(ag).sort((a,b)=>sum(b[1],'leads')-sum(a[1],'leads')).forEach(([n,rs])=>{ldL.push(n);ldV.push(sum(rs,'leads'))});
    makeChart('leadsAudienceChart','bar',ldL,[{data:ldV,backgroundColor:'rgba(105,175,54,.7)',borderRadius:6,borderSkipped:false}],{y:{beginAtZero:true}},{indexAxis:'y'});
}

// META PAGE
function renderMetaPage(){
    const d=MD,sp=sum(d,'cost'),ld=sum(d,'leads'),cl=sum(d,'cl'),im=sum(d,'imp'),lkCl=sum(d,'linkCl');
    const cpl=ld>0?sp/ld:0,ctr=im>0?(cl/im)*100:0;
    const ic='meta-i';
    document.getElementById('metaKpiGrid').innerHTML=kpiHTML([
        {label:'Dépenses',value:fE(sp),sub:'Lead Gen',icon:ic,svg:'<line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>'},
        {label:'Leads',value:fN(ld),sub:fN(im)+' impr.',icon:ic,svg:'<path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/>'},
        {label:'Coût / Lead',value:ld>0?fE2(cpl):'-',sub:fN(lkCl)+' clics liens',icon:ic,svg:'<circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>'},
        {label:'CTR',value:fPct(ctr),sub:'Moyenne',icon:ic,svg:'<polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>'}
    ]);
    const mo=grpMonth(d),ks=Object.keys(mo).sort();
    makeChart('metaSpendChart','bar',ks.map(mLabel),[{data:ks.map(k=>sum(mo[k],'cost')),backgroundColor:'#1877f2bb',borderRadius:6,borderSkipped:false}],{y:{ticks:{callback:v=>fE(v)}}});
    makeChart('metaLeadsChart','bar',ks.map(mLabel),[{data:ks.map(k=>sum(mo[k],'leads')),backgroundColor:'rgba(105,175,54,.7)',borderRadius:6,borderSkipped:false}],{y:{beginAtZero:true}});
    const ag=grpAd(d),tbody=document.getElementById('metaTableBody');
    const entries=Object.entries(ag).sort((a,b)=>sum(b[1],'cost')-sum(a[1],'cost'));
    tbody.innerHTML=entries.map(([name,rows])=>{
        const im2=sum(rows,'imp'),cl2=sum(rows,'cl'),lk=sum(rows,'linkCl'),co=sum(rows,'cost'),ld2=sum(rows,'leads');
        const ct=im2>0?(cl2/im2)*100:0,cp=ld2>0?co/ld2:0;
        return'<tr><td><strong style="color:var(--text-primary)">'+name+'</strong></td><td>'+fN(im2)+'</td><td>'+fN(cl2)+'</td><td>'+fN(lk)+'</td><td class="td-b">'+fPct(ct)+'</td><td class="td-b">'+fE2(co)+'</td><td class="td-b">'+fN(ld2)+'</td><td>'+(ld2>0?fE2(cp):'-')+'</td></tr>'
    }).join('');
}

// LINKEDIN PAGE
function renderLinkedinPage(){
    const d=LI,sp=sum(d,'cost'),ld=sum(d,'leads'),cl=sum(d,'cl'),im=sum(d,'imp'),fo=sum(d,'formOpens');
    const cpl=ld>0?sp/ld:0,ctr=im>0?(cl/im)*100:0;
    const ic='linkedin-i';
    document.getElementById('linkedinKpiGrid').innerHTML=kpiHTML([
        {label:'Dépenses',value:fE(sp),sub:'LinkedIn Lead Gen',icon:ic,svg:'<line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>'},
        {label:'Leads',value:fN(ld),sub:fN(fo)+' formulaires ouverts',icon:ic,svg:'<path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/>'},
        {label:'Coût / Lead',value:ld>0?fE2(cpl):'-',sub:fN(cl)+' clics',icon:ic,svg:'<circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>'},
        {label:'CTR',value:fPct(ctr),sub:'Moyenne',icon:ic,svg:'<polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>'}
    ]);
    const mo=grpMonth(d),ks=Object.keys(mo).sort();
    makeChart('linkedinSpendChart','bar',ks.map(mLabel),[{data:ks.map(k=>sum(mo[k],'cost')),backgroundColor:'rgba(10,102,194,.75)',borderRadius:6,borderSkipped:false}],{y:{ticks:{callback:v=>fE(v)}}});
    makeChart('linkedinLeadsChart','bar',ks.map(mLabel),[{data:ks.map(k=>sum(mo[k],'leads')),backgroundColor:'rgba(105,175,54,.7)',borderRadius:6,borderSkipped:false}],{y:{beginAtZero:true}});
    const ag=grpAd(d),tbody=document.getElementById('linkedinTableBody');
    const entries=Object.entries(ag).sort((a,b)=>sum(b[1],'cost')-sum(a[1],'cost'));
    tbody.innerHTML=entries.map(([name,rows])=>{
        const im2=sum(rows,'imp'),cl2=sum(rows,'cl'),co=sum(rows,'cost'),ld2=sum(rows,'leads'),fo2=sum(rows,'formOpens');
        const ct=im2>0?(cl2/im2)*100:0,cp=ld2>0?co/ld2:0;
        return'<tr><td><strong style="color:var(--text-primary)">'+name+'</strong></td><td>'+fN(im2)+'</td><td>'+fN(cl2)+'</td><td class="td-b">'+fPct(ct)+'</td><td class="td-b">'+fE2(co)+'</td><td class="td-b">'+fN(ld2)+'</td><td>'+fN(fo2)+'</td><td>'+(ld2>0?fE2(cp):'-')+'</td></tr>'
    }).join('');
}

// TABLE (Performances)
function renderTable(p){
    const d=getData(p),g={};
    d.forEach(r=>{const k=r.p+'::'+(r.ad||r.camp||'Autre');if(!g[k])g[k]={p:r.p,n:r.ad||r.camp||'Autre',rows:[]};g[k].rows.push(r)});
    const tb=document.getElementById('tableBody'),es=Object.values(g).sort((a,b)=>sum(b.rows,'cost')-sum(a.rows,'cost'));
    if(!es.length){tb.innerHTML='<tr><td colspan="9" style="text-align:center;padding:40px;color:var(--text-tertiary)">Aucune donnée sur cette période</td></tr>';return}
    tb.innerHTML=es.map(e=>{
        const im=sum(e.rows,'imp'),cl=sum(e.rows,'cl'),co=sum(e.rows,'cost'),ld=sum(e.rows,'leads');
        const ct=im>0?(cl/im)*100:0,cp=ld>0?co/ld:0;
        const pp=ld>0&&cp>0?Math.min(100,Math.max(10,100-(cp/50*100))):10,pc=pp>65?'g':pp>40?'m':'l';
        const isM=e.p==='meta';
        const ico=isM?'<div class="camp-icon meta-bg">'+ICO_META+'</div>':'<div class="camp-icon linkedin-bg">'+ICO_LI+'</div>';
        const platLabel=isM?'Meta':'LinkedIn';
        return'<tr><td><div class="camp-name">'+ico+'<div class="camp-info"><div class="n">'+e.n+'</div></div></div></td><td>'+platLabel+'</td><td>'+fN(im)+'</td><td>'+fN(cl)+'</td><td class="td-b">'+fPct(ct)+'</td><td class="td-b">'+fE2(co)+'</td><td class="td-b">'+fN(ld)+'</td><td>'+(ld>0?fE2(cp):'-')+'</td><td><div class="perf-bar"><div class="perf-fill '+pc+'" style="width:'+pp+'%"></div></div></td></tr>'
    }).join('');
}

// REPORTS
function renderReports(){
    const el=document.getElementById('reportSummary');
    el.innerHTML='';
    [{k:'meta',l:'Meta Ads',d:MD,c:'var(--meta-blue)',bg:'var(--meta-blue-soft)'},{k:'linkedin',l:'LinkedIn Ads',d:LI,c:'var(--linkedin-blue)',bg:'var(--linkedin-blue-soft)'}].forEach(p=>{
        const sp=sum(p.d,'cost'),ld=sum(p.d,'leads'),cl=sum(p.d,'cl'),im=sum(p.d,'imp'),lkCl=sum(p.d,'linkCl'),fo=sum(p.d,'formOpens');
        const cpl=ld>0?sp/ld:0,ctr=im>0?(cl/im)*100:0;
        const isLI=p.k==='linkedin';
        const extraMetric=isLI?'<div class="plat-metric" style="background:'+p.bg+'"><div class="lbl">Formulaires</div><div class="val">'+fN(fo)+'</div></div>':'<div class="plat-metric" style="background:'+p.bg+'"><div class="lbl">Clics liens</div><div class="val">'+fN(lkCl)+'</div></div>';
        el.innerHTML+='<div class="card"><div class="plat-block-header"><div class="dot" style="background:'+p.c+'"></div><strong>'+p.l+'</strong></div><div class="plat-metrics"><div class="plat-metric" style="background:'+p.bg+'"><div class="lbl">Dépenses</div><div class="val">'+fE(sp)+'</div></div><div class="plat-metric" style="background:'+p.bg+'"><div class="lbl">Leads</div><div class="val">'+fN(ld)+'</div></div><div class="plat-metric" style="background:'+p.bg+'"><div class="lbl">Coût / Lead</div><div class="val">'+(ld>0?fE2(cpl):'-')+'</div></div><div class="plat-metric" style="background:'+p.bg+'"><div class="lbl">CTR</div><div class="val">'+fPct(ctr)+'</div></div><div class="plat-metric" style="background:'+p.bg+'"><div class="lbl">Impressions</div><div class="val">'+fN(im)+'</div></div><div class="plat-metric" style="background:'+p.bg+'"><div class="lbl">Clics</div><div class="val">'+fN(cl)+'</div></div>'+extraMetric+'<div class="plat-metric" style="background:'+p.bg+'"><div class="lbl">Campagnes</div><div class="val">'+Object.keys(grpAd(p.d)).length+'</div></div></div></div>';
    });
    // CPL trend
    const mm=grpMonth(MD),lm=grpMonth(LI),ks=[...new Set([...Object.keys(mm),...Object.keys(lm)])].sort();
    const mCPL=ks.map(k=>{const d=mm[k]||[];const c=sum(d,'cost'),l=sum(d,'leads');return l>0?Math.round(c/l*100)/100:null});
    const liCPL=ks.map(k=>{const d=lm[k]||[];const c=sum(d,'cost'),l=sum(d,'leads');return l>0?Math.round(c/l*100)/100:null});
    makeChart('reportCplChart','line',ks.map(mLabel),[
        {label:'Meta CPL',data:mCPL,borderColor:'#1877f2',backgroundColor:'rgba(24,119,242,.08)',borderWidth:2.5,fill:true,tension:.4,pointRadius:4,pointBackgroundColor:'#1877f2',spanGaps:true},
        {label:'LinkedIn CPL',data:liCPL,borderColor:'#0a66c2',backgroundColor:'rgba(10,102,194,.06)',borderWidth:2.5,fill:true,tension:.4,pointRadius:4,pointBackgroundColor:'#0a66c2',spanGaps:true}
    ],{y:{ticks:{callback:v=>v+' €'}}});
}

// CHART FACTORIES
function makeChart(id,type,labels,datasets,scaleOpts={},extra={}){
    const ctx=document.getElementById(id);if(!ctx)return;
    if(charts[id])charts[id].destroy();
    charts[id]=new Chart(ctx,{type,data:{labels,datasets:datasets.map(d=>({...d,barPercentage:.6,categoryPercentage:.7}))},options:{responsive:true,maintainAspectRatio:false,...extra,plugins:{legend:{display:false},tooltip:{backgroundColor:'#1a1a1a',titleFont:{size:11,weight:'600'},bodyFont:{size:11},padding:10,cornerRadius:8,boxPadding:3}},scales:{x:{grid:{display:false},ticks:{font:{size:10,weight:'500'}},border:{display:false},...(scaleOpts.x||{})},y:{grid:{color:'rgba(0,0,0,.04)',drawBorder:false},ticks:{font:{size:10}},border:{display:false},...(scaleOpts.y||{})}}}});
}
function makeDoughnut(id,labels,data,colors){
    const ctx=document.getElementById(id);if(!ctx)return;
    if(charts[id])charts[id].destroy();
    const total=data.reduce((a,b)=>a+b,0);
    charts[id]=new Chart(ctx,{type:'doughnut',data:{labels,datasets:[{data,backgroundColor:colors.slice(0,data.length),borderWidth:0,hoverOffset:5,spacing:2}]},options:{responsive:true,maintainAspectRatio:false,cutout:'70%',plugins:{legend:{position:'bottom',labels:{padding:10,usePointStyle:true,pointStyle:'circle',font:{size:10,weight:'500'}}},tooltip:{backgroundColor:'#1a1a1a',padding:10,cornerRadius:8,callbacks:{label:c=>' '+c.label+': '+fE2(c.raw)}}}},plugins:[{id:'ct',beforeDraw(ch){const{ctx:c,width:w}=ch;const cy=(ch.chartArea.top+ch.chartArea.bottom)/2;c.save();c.font='800 20px "Plus Jakarta Sans"';c.fillStyle='#1a1a1a';c.textAlign='center';c.textBaseline='middle';c.fillText(fE(total),w/2,cy-7);c.font='500 10px "Plus Jakarta Sans"';c.fillStyle='#8a8a8a';c.fillText('Total',w/2,cy+12);c.restore()}}]});
}

// INTERACTIONS
function switchPlatform(p,btn){curPlatform=p;document.querySelectorAll('#page-overview .platform-tab').forEach(t=>t.classList.remove('active'));btn.classList.add('active');renderKPIs(p)}
function filterTable(p,btn){curTableFilter=p;btn.closest('.table-filters').querySelectorAll('.filter-chip').forEach(c=>c.classList.remove('active'));btn.classList.add('active');renderTable(p)}
function toggleSidebar(){document.getElementById('sidebar').classList.toggle('open');document.getElementById('sidebarOverlay').classList.toggle('show')}
document.getElementById('sidebarOverlay').addEventListener('click',toggleSidebar);

init();
</script>
</body>
</html>
